pipeline {
    agent any

    environment {
        NEXUS_URL = 'http://192.168.33.10:8081/repository/nexus/'
        NEXUS_REPO = 'nexus'
        CREDENTIALS_ID = 'nexus-credentials' // Remplacez par votre ID de credentials
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                script {
                    sh 'mvn clean package'
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    sh 'mvn test'
                }
            }
        }

        stage('Upload to Nexus') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${CREDENTIALS_ID}", usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    script {
                        def jarFilePath = "${env.WORKSPACE}/target/tp-foyer-5.0.0.jar"

                        // Vérification de l'existence du fichier JAR
                        sh "ls -l ${jarFilePath}"

                        // Commande de déploiement
                        sh """
                        mvn deploy:deploy-file \
                            -Durl=${NEXUS_URL}/repository/${NEXUS_REPO} \
                            -DrepositoryId=${NEXUS_REPO} \
                            -Dfile=${jarFilePath} \
                            -DgroupId=tn.esprit \
                            -DartifactId=tp-foyer \
                            -Dversion=5.0.0 \
                            -Dpackaging=jar \
                            -DgeneratePom=true \
                            -Dusername=${USERNAME} \
                            -Dpassword=${PASSWORD}
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Le déploiement a réussi !'
        }
        failure {
            echo 'Échec du déploiement.'
        }
    }
}



